name: Detect Affected Apps (Turborepo)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  turbo-graph:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # necessÃ¡rio para acessar histÃ³rico e outras branches

      - name: Fetch main branch
        run: git fetch origin main

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          corepack enable
          yarn install --frozen-lockfile

      - name: Generate Turbo Graph
        id: turbo
        run: |
          echo "## ðŸ“¦ Apps afetados por este PR:" > pr-summary.txt

          CHANGED_PACKAGES=$(git diff --name-only origin/main...HEAD | grep 'package.json' | xargs -I{} dirname {})
          echo "Pacotes alterados: $CHANGED_PACKAGES"

          AFFECTED_APPS=()

          for pkg in $CHANGED_PACKAGES; do
            echo "Analisando dependentes de $pkg..."
            APPS=$(npx turbo run build --filter=...[$pkg] --filter=@repo/* --dry=json \
                  | jq -r '.tasks | to_entries[] | select(.value.status == "scheduled") | .value.package')
            AFFECTED_APPS+=($APPS)
          done

          # Remover duplicados
          UNIQ_APPS=$(printf "%s\n" "${AFFECTED_APPS[@]}" | sort -u)

          echo "Apps afetados:" $UNIQ_APPS

          for app in $UNIQ_APPS; do
            echo "- $app" >> pr-summary.txt
          done

      - name: Comment on Pull Request
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr-summary.txt
